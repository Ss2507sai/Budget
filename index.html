<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Dashboard Pro - Ultimate Edition</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    background: linear-gradient(135deg, #f5f0ff 0%, #ffe5f0 100%);
    padding: 20px;
    min-height: 100vh;
    transition: background 0.3s ease;
    padding-bottom: 80px;
}

/* ===== ALERT BANNER ===== */
.alert-banner {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    z-index: 9999;
    animation: slideDown 0.3s ease;
}

.alert-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px 20px;
    max-width: 1400px;
    margin: 0 auto;
}

.alert-icon {
    font-size: 24px;
    margin-right: 12px;
}

.alert-message {
    flex: 1;
    font-weight: 600;
    font-size: 14px;
}

.alert-close {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}

.alert-close:hover {
    background: rgba(255,255,255,0.3);
}

@keyframes slideDown {
    from { transform: translateY(-100%); }
    to { transform: translateY(0); }
}

/* ===== LOADING SCREEN ===== */
.loading-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    color: #333;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #e9d5ff;
    border-top-color: #8b5cf6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ===== AUTH SCREEN ===== */
.auth-screen {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
}

.auth-box {
    background: white;
    padding: 40px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 400px;
}

.auth-box h1 {
    text-align: center;
    color: #333;
    margin-bottom: 10px;
    font-size: 28px;
}

.subtitle {
    text-align: center;
    color: #666;
    font-size: 12px;
    letter-spacing: 2px;
    margin-bottom: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
    font-size: 14px;
}

.form-group input {
    width: 100%;
    padding: 12px;
    border: 2px solid #e0d4f7;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s;
}

.form-group input:focus {
    outline: none;
    border-color: #8b5cf6;
}

.btn {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s;
}

.btn-primary {
    background: #8b5cf6;
    color: white;
    margin-bottom: 10px;
}

.btn-primary:hover {
    background: #7c3aed;
}

.btn-primary:disabled {
    background: #c4b5fd;
    cursor: not-allowed;
}

.error-message {
    background: #fee2e2;
    color: #dc2626;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 15px;
    font-size: 14px;
}

.success-message {
    background: #d1fae5;
    color: #059669;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 15px;
    font-size: 14px;
}

.toggle-text {
    text-align: center;
    margin-top: 20px;
    color: #666;
    font-size: 14px;
}

.toggle-text a {
    color: #8b5cf6;
    text-decoration: none;
    font-weight: 600;
}

.toggle-text a:hover {
    text-decoration: underline;
}

/* ===== TOAST NOTIFICATIONS ===== */
.toast-container {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10001;
    display: flex;
    flex-direction: column;
    gap: 10px;
    pointer-events: none;
}

.toast {
    background: white;
    padding: 15px 25px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-size: 14px;
    font-weight: 600;
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s ease;
    pointer-events: all;
}

.toast.show {
    opacity: 1;
    transform: translateY(0);
}

.toast-success {
    border-left: 4px solid #10b981;
    color: #10b981;
}

.toast-error {
    border-left: 4px solid #ef4444;
    color: #ef4444;
}

.toast-info {
    border-left: 4px solid #3b82f6;
    color: #3b82f6;
}

/* ===== USER AVATAR ===== */
.user-avatar, .user-avatar-small {
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    flex-shrink: 0;
}

.user-avatar {
    width: 40px;
    height: 40px;
    font-size: 16px;
}

.user-avatar-small {
    width: 32px;
    height: 32px;
    font-size: 14px;
}

/* ===== USER WIDGET DROPDOWN ===== */
.user-widget-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
}

.widget-toggle-btn {
    background: white;
    border: 2px solid #e9d5ff;
    border-radius: 50px;
    padding: 8px 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    font-weight: 600;
    color: #333;
}

.widget-toggle-btn:hover {
    box-shadow: 0 6px 20px rgba(139, 92, 246, 0.3);
    transform: translateY(-2px);
    border-color: #8b5cf6;
}

.widget-arrow {
    font-size: 10px;
    transition: transform 0.3s ease;
}

.widget-toggle-btn.active .widget-arrow {
    transform: rotate(180deg);
}

.user-dropdown-menu {
    position: absolute;
    top: 60px;
    right: 0;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    min-width: 280px;
    max-width: 320px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    overflow: hidden;
}

.user-dropdown-menu.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.dropdown-header {
    padding: 16px;
    background: #f8f5ff;
}

.dropdown-actions {
    padding: 8px;
    max-height: 400px;
    overflow-y: auto;
}

.menu-item-btn, .mobile-menu-btn {
    width: 100%;
    padding: 12px 16px;
    background: transparent;
    border: none;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
    font-weight: 500;
    color: #333;
    text-align: left;
    margin-bottom: 4px;
}

.menu-item-btn:hover, .mobile-menu-btn:hover {
    background: #f8f5ff;
    transform: translateX(4px);
}

.btn-icon {
    font-size: 18px;
    width: 24px;
    text-align: center;
}

.dark-mode-btn {
    background: #374151;
    color: white;
    justify-content: center;
}

.dark-mode-btn:hover {
    background: #1f2937;
    transform: translateX(0) !important;
}

.danger-btn:hover {
    background: #fee2e2;
    color: #dc2626;
}

.logout-btn {
    color: #ef4444;
    font-weight: 600;
}

.logout-btn:hover {
    background: #fee2e2;
}

.menu-divider {
    height: 1px;
    background: #e5e7eb;
    margin: 8px 0;
}

/* ===== MOBILE BOTTOM NAVIGATION ===== */
.mobile-bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-around;
    padding: 8px 0;
    z-index: 999;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
}

.nav-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    background: none;
    border: none;
    padding: 8px;
    cursor: pointer;
    color: #666;
    transition: all 0.2s;
}

.nav-btn.active {
    color: #8b5cf6;
}

.nav-icon {
    font-size: 24px;
}

.nav-label {
    font-size: 11px;
    font-weight: 600;
}

.mobile-section {
    display: block;
}

.desktop-only {
    display: block;
}

.mobile-only {
    display: none;
}

.desktop-content {
    display: block;
}

/* ===== MOBILE MENU SECTION ===== */
.mobile-menu-section {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
}

.mobile-menu-header {
    display: flex;
    align-items: center;
    padding: 20px;
    background: #f8f5ff;
    border-radius: 12px;
    margin-bottom: 20px;
}

.mobile-menu-items {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* ===== DASHBOARD STYLES ===== */
.container {
    max-width: 1400px;
    margin: 0 auto;
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    transition: background 0.3s ease, color 0.3s ease;
}

.header {
    text-align: center;
    margin-bottom: 30px;
}

.header h1 {
    font-size: 36px;
    font-weight: 700;
    color: #333;
    margin-bottom: 5px;
    transition: color 0.3s ease;
}

.header .subtitle {
    color: #666;
    font-size: 14px;
    letter-spacing: 2px;
    transition: color 0.3s ease;
}

.top-controls {
    background: #f8f5ff;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    transition: background 0.3s ease;
}

.control-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.control-group label {
    font-weight: 600;
    font-size: 12px;
    color: #333;
    letter-spacing: 1px;
    transition: color 0.3s ease;
}

.date-inputs {
    display: flex;
    align-items: center;
    gap: 10px;
}

.date-inputs input {
    flex: 1;
    padding: 10px;
    border: 2px solid #e0d4f7;
    border-radius: 6px;
    font-size: 14px;
    transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
}

.control-group select {
    padding: 10px;
    border: 2px solid #e0d4f7;
    border-radius: 6px;
    font-size: 14px;
    background: white;
    transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
}

/* ===== 50/30/20 RULE VISUALIZER ===== */
.rule-visualizer {
    margin-bottom: 25px;
    padding: 30px !important;
}

.rule-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-top: 20px;
}

.rule-item {
    background: #f8f5ff;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
}

.rule-percentage {
    font-size: 48px;
    font-weight: 700;
    margin-bottom: 10px;
}

.rule-label {
    font-size: 14px;
    font-weight: 600;
    color: #666;
    margin-bottom: 10px;
}

.rule-amount {
    font-size: 20px;
    font-weight: 700;
    color: #333;
    margin-bottom: 10px;
}

.rule-bar {
    height: 8px;
    background: #e9d5ff;
    border-radius: 4px;
    overflow: hidden;
    margin-top: 10px;
}

.rule-bar-fill {
    height: 100%;
    transition: width 0.3s ease;
}

.rule-status {
    font-size: 12px;
    font-weight: 600;
    margin-top: 10px;
}

/* ===== SAVINGS RATE CALCULATOR ===== */
.savings-rate-card {
    margin-bottom: 25px;
    padding: 30px !important;
}

.savings-rate-display {
    text-align: center;
    margin: 20px 0;
}

.savings-rate-percentage {
    font-size: 64px;
    font-weight: 700;
    color: #8b5cf6;
    margin-bottom: 10px;
}

.savings-rate-label {
    font-size: 16px;
    color: #666;
    font-weight: 600;
}

.savings-trend {
    display: flex;
    justify-content: space-around;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e5e7eb;
}

.trend-item {
    text-align: center;
}

.trend-value {
    font-size: 24px;
    font-weight: 700;
    color: #333;
}

.trend-label {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
}

/* ===== SUMMARY CARDS ===== */
.summary-cards {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 15px;
    margin-bottom: 25px;
}

.summary-card {
    background: #e9d5ff;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    transition: all 0.3s ease;
    animation: slideIn 0.3s ease;
}

.summary-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
}

.summary-card .label {
    font-size: 11px;
    font-weight: 700;
    color: #555;
    letter-spacing: 1px;
    margin-bottom: 8px;
    transition: color 0.3s ease;
}

.summary-card .amount {
    font-size: 24px;
    font-weight: 700;
    color: #333;
    transition: color 0.3s ease;
}

.dashboard-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
    margin-bottom: 25px;
}

.dashboard-card {
    background: #f8f5ff;
    padding: 20px;
    border-radius: 8px;
    transition: background 0.3s ease;
}

.dashboard-card.white {
    background: white;
    border: 2px solid #e9d5ff;
    transition: background 0.3s ease, border-color 0.3s ease;
}

.dashboard-card h3 {
    font-size: 13px;
    font-weight: 700;
    text-align: center;
    color: #333;
    letter-spacing: 1px;
    margin-bottom: 15px;
    transition: color 0.3s ease;
}

.goals-section {
    background: #f8f5ff;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 25px;
    transition: background 0.3s ease;
}

.goals-section h3 {
    text-align: center;
    margin-bottom: 15px;
    color: #333;
    font-size: 16px;
    transition: color 0.3s ease;
}

.financial-table {
    font-size: 13px;
}

.financial-table table {
    width: 100%;
    border-collapse: collapse;
}

.financial-table th {
    text-align: right;
    font-weight: 700;
    padding: 6px 8px;
    font-size: 11px;
    transition: color 0.3s ease;
}

.financial-table td {
    padding: 6px 8px;
    text-align: right;
    transition: color 0.3s ease;
}

.financial-table td:first-child {
    text-align: left;
}

.financial-table .total-row {
    border-top: 2px solid #c4b5fd;
    font-weight: 700;
}

.amount-left {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
}

.amount-left .big-amount {
    font-size: 48px;
    font-weight: 700;
    color: #333;
    margin-top: 10px;
    transition: color 0.3s ease;
}

.cash-flow-chart {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.chart-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.chart-label {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: #555;
    transition: color 0.3s ease;
}

.chart-bars {
    display: flex;
    gap: 6px;
    height: 24px;
}

.chart-bar {
    border-radius: 4px;
    transition: width 0.3s ease;
}

.chart-bar.planned {
    background: #f8bbd0;
}

.chart-bar.actual {
    background: #c4b5fd;
}

.category-tables {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.category-card {
    background: #f8f5ff;
    padding: 20px;
    border-radius: 8px;
    transition: background 0.3s ease;
}

.category-card h3 {
    font-size: 13px;
    font-weight: 700;
    text-align: center;
    color: #333;
    letter-spacing: 1px;
    margin-bottom: 15px;
    transition: color 0.3s ease;
}

.category-table {
    width: 100%;
    font-size: 12px;
}

.category-table thead th {
    text-align: center;
    font-weight: 700;
    padding: 8px 4px;
    font-size: 11px;
    border-bottom: 2px solid #c4b5fd;
    transition: color 0.3s ease;
}

.category-table tbody td {
    padding: 6px 4px;
    text-align: center;
    transition: color 0.3s ease;
}

.category-table tbody td:first-child {
    text-align: left;
}

.category-table input[type="number"] {
    width: 90%;
    padding: 4px;
    border: 1px solid #e0d4f7;
    border-radius: 4px;
    text-align: center;
    font-size: 12px;
    transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
}

.category-table input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
}

.category-table .total-row {
    border-top: 2px solid #8b5cf6;
    font-weight: 700;
}

.item-row {
    display: flex;
    align-items: center;
    gap: 6px;
}

.item-row span {
    font-size: 12px;
    transition: color 0.3s ease;
}

/* ===== DARK MODE ===== */
body.dark-mode {
    background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
}

body.dark-mode .container,
body.dark-mode .auth-box {
    background: #1f2937;
    color: #e5e7eb;
}

body.dark-mode .header h1 {
    color: #e5e7eb;
}

body.dark-mode .header .subtitle {
    color: #9ca3af;
}

body.dark-mode .category-card h3,
body.dark-mode .dashboard-card h3 {
    color: #e5e7eb;
}

body.dark-mode .summary-card {
    background: #374151;
}

body.dark-mode .summary-card .label {
    color: #9ca3af;
}

body.dark-mode .summary-card .amount {
    color: #e5e7eb;
}

body.dark-mode .dashboard-card {
    background: #374151;
}

body.dark-mode .dashboard-card.white {
    background: #1f2937;
    border-color: #374151;
}

body.dark-mode .category-card {
    background: #374151;
}

body.dark-mode .top-controls {
    background: #374151;
}

body.dark-mode .control-group label {
    color: #e5e7eb;
}

body.dark-mode .date-inputs input,
body.dark-mode .control-group select {
    background: #111827;
    color: #e5e7eb;
    border-color: #4b5563;
}

body.dark-mode .category-table input[type="number"] {
    background: #111827;
    color: #e5e7eb;
    border-color: #4b5563;
}

body.dark-mode .financial-table td,
body.dark-mode .financial-table th,
body.dark-mode .category-table td,
body.dark-mode .category-table th {
    color: #e5e7eb;
}

body.dark-mode .goals-section {
    background: #374151;
}

body.dark-mode .goals-section h3 {
    color: #e5e7eb;
}

body.dark-mode .chart-label {
    color: #9ca3af;
}

body.dark-mode .amount-left .big-amount {
    color: #e5e7eb;
}

body.dark-mode .item-row span {
    color: #e5e7eb;
}

body.dark-mode .form-group label {
    color: #e5e7eb;
}

body.dark-mode .form-group input {
    background: #111827;
    color: #e5e7eb;
    border-color: #4b5563;
}

body.dark-mode .toggle-text {
    color: #9ca3af;
}

body.dark-mode .toast {
    background: #374151;
}

body.dark-mode .widget-toggle-btn {
    background: #374151;
    border-color: #4b5563;
    color: #e5e7eb;
}

body.dark-mode .user-dropdown-menu {
    background: #1f2937;
    border: 1px solid #374151;
}

body.dark-mode .dropdown-header {
    background: #374151;
}

body.dark-mode .dropdown-header p {
    color: #e5e7eb !important;
}

body.dark-mode .menu-item-btn, 
body.dark-mode .mobile-menu-btn {
    color: #e5e7eb;
}

body.dark-mode .menu-item-btn:hover,
body.dark-mode .mobile-menu-btn:hover {
    background: #374151;
}

body.dark-mode .menu-divider {
    background: #4b5563;
}

body.dark-mode .danger-btn:hover {
    background: #7f1d1d;
    color: #fca5a5;
}

body.dark-mode .logout-btn {
    color: #fca5a5;
}

body.dark-mode .logout-btn:hover {
    background: #7f1d1d;
}

body.dark-mode .mobile-bottom-nav {
    background: #1f2937;
    border-top-color: #374151;
}

body.dark-mode .nav-btn {
    color: #9ca3af;
}

body.dark-mode .nav-btn.active {
    color: #a78bfa;
}

body.dark-mode .mobile-menu-section {
    background: #1f2937;
}

body.dark-mode .mobile-menu-header {
    background: #374151;
}

body.dark-mode .rule-item {
    background: #374151;
}

body.dark-mode .rule-label,
body.dark-mode .savings-rate-label,
body.dark-mode .trend-label {
    color: #9ca3af;
}

body.dark-mode .rule-amount,
body.dark-mode .trend-value {
    color: #e5e7eb;
}

/* ===== ANIMATIONS ===== */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.dashboard-card {
    animation: fadeIn 0.4s ease;
}

/* ===== RESPONSIVE - MOBILE ===== */
@media (max-width: 768px) {
    body {
        padding: 10px;
        padding-bottom: 80px;
    }

    .container {
        padding: 15px;
    }

    .header h1 {
        font-size: 24px;
    }

    .desktop-only {
        display: none !important;
    }

    .mobile-only {
        display: block !important;
    }

    .desktop-content {
        display: none !important;
    }

    .mobile-section {
        display: none;
    }

    .mobile-section.active {
        display: block;
    }

    .summary-cards {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .dashboard-row {
        grid-template-columns: 1fr;
    }
    
    .category-tables {
        grid-template-columns: 1fr;
    }
    
    .top-controls {
        grid-template-columns: 1fr;
    }
    
    .toast-container {
        width: 90%;
        max-width: 400px;
    }

    .amount-left .big-amount {
        font-size: 36px;
    }

    .auth-box {
        padding: 30px 20px;
    }

    .category-table {
        font-size: 11px;
    }

    .category-table input[type="number"] {
        font-size: 11px;
        padding: 3px;
    }

    .rule-container {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .rule-percentage {
        font-size: 36px;
    }

    .savings-rate-percentage {
        font-size: 48px;
    }

    .alert-content {
        padding: 12px 15px;
    }

    .alert-message {
        font-size: 12px;
    }
}

/* ===== PRINT ===== */
@media print {
    body {
        background: white;
        padding: 0;
    }

    .user-widget-container,
    .mobile-bottom-nav,
    .btn-dark-mode,
    button {
        display: none !important;
    }

    .container {
        box-shadow: none;
    }

    .summary-card {
        page-break-inside: avoid;
    }
}

/* ===== ACCESSIBILITY ===== */
*:focus {
    outline: 2px solid #8b5cf6;
    outline-offset: 2px;
}

button:focus,
input:focus,
select:focus {
    outline: 2px solid #8b5cf6;
    outline-offset: 2px;
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar {
    width: 10px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
    background: #8b5cf6;
    border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
    background: #7c3aed;
}

body.dark-mode ::-webkit-scrollbar-track {
    background: #1f2937;
}

body.dark-mode ::-webkit-scrollbar-thumb {
    background: #4b5563;
}

body.dark-mode ::-webkit-scrollbar-thumb:hover {
    background: #6b7280;
}

/* ===== UTILITY ===== */
.text-center {
    text-align: center;
}

.mb-10 {
    margin-bottom: 10px;
}

.mt-10 {
    margin-top: 10px;
}

.hidden {
    display: none;
}

.fade-in {
    animation: fadeIn 0.3s ease;
}

html {
    scroll-behavior: smooth;
}

body {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div id="toastContainer" class="toast-container"></div>
    <div id="alertBanner" class="alert-banner" style="display: none;">
        <div class="alert-content">
            <span class="alert-icon">‚ö†Ô∏è</span>
            <span class="alert-message" id="alertMessage"></span>
            <button class="alert-close" onclick="closeAlertBanner()">√ó</button>
        </div>
    </div>

    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <p>Loading your dashboard...</p>
    </div>

    <div id="authScreen" class="auth-screen" style="display: none;">
        <div class="auth-box">
            <h1 id="authTitle">Login</h1>
            <div class="subtitle">‚Ä¢ULTIMATE BUDGET DASHBOARD‚Ä¢</div>
            <div id="errorMessage" class="error-message" style="display: none;"></div>
            <div id="successMessage" class="success-message" style="display: none;"></div>
            <form id="authForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6">
                </div>
                <button type="submit" class="btn btn-primary" id="authSubmitBtn">Login</button>
            </form>
            <div class="toggle-text">
                <span id="toggleText">Don't have an account?</span>
                <a href="#" id="toggleAuth">Sign Up</a>
            </div>
        </div>
    </div>

    <div id="mainDashboard" style="display: none;">
        <div class="user-widget-container desktop-only">
            <button class="widget-toggle-btn" onclick="toggleUserMenu()" id="widgetToggleBtn">
                <span id="userAvatarWidget" class="user-avatar-small"></span>
                <span class="widget-arrow">‚ñº</span>
            </button>
            <div class="user-dropdown-menu" id="userDropdownMenu">
                <div class="dropdown-header">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <div id="userAvatar" class="user-avatar"></div>
                        <div style="flex: 1;">
                            <p style="margin: 0; font-size: 11px; color: #666;">Logged in as:</p>
                            <p style="margin: 0; font-weight: 600; font-size: 13px; color: #333; word-break: break-all;" id="userEmailDisplay"></p>
                        </div>
                    </div>
                    <button onclick="toggleDarkMode()" class="menu-item-btn dark-mode-btn">
                        <span id="darkModeIcon">üåô</span>
                        <span id="darkModeText">Dark Mode</span>
                    </button>
                </div>
                <div class="menu-divider"></div>
                <div class="dropdown-actions">
                    <button onclick="exportToPDF(); closeUserMenu();" class="menu-item-btn">
                        <span class="btn-icon">üì•</span><span>Export PDF</span>
                    </button>
                    <button onclick="exportToCSV(); closeUserMenu();" class="menu-item-btn">
                        <span class="btn-icon">üìä</span><span>Export CSV</span>
                    </button>
                    <button onclick="showBackupRestore(); closeUserMenu();" class="menu-item-btn">
                        <span class="btn-icon">üíæ</span><span>Backup & Restore</span>
                    </button>
                    <button onclick="showGoalsModal(); closeUserMenu();" class="menu-item-btn">
                        <span class="btn-icon">üéØ</span><span>Budget Goals</span>
                    </button>
                    <button onclick="showRecurringTransactions(); closeUserMenu();" class="menu-item-btn">
                        <span class="btn-icon">üîÑ</span><span>Recurring Items</span>
                    </button>
                    <button onclick="showMonthComparison(); closeUserMenu();" class="menu-item-btn">
                        <span class="btn-icon">üìä</span><span>Compare Months</span>
                    </button>
                    <button onclick="viewPreviousMonths(); closeUserMenu();" class="menu-item-btn">
                        <span class="btn-icon">üìÖ</span><span>Previous Months</span>
                    </button>
                    <button onclick="viewYearlySummary(); closeUserMenu();" class="menu-item-btn">
                        <span class="btn-icon">üìà</span><span>Yearly Summary</span>
                    </button>
                    <button onclick="clearAllData(); closeUserMenu();" class="menu-item-btn danger-btn">
                        <span class="btn-icon">üóëÔ∏è</span><span>Clear All Data</span>
                    </button>
                </div>
                <div class="menu-divider"></div>
                <button onclick="handleLogout()" class="menu-item-btn logout-btn">
                    <span class="btn-icon">üö™</span><span>Logout</span>
                </button>
            </div>
        </div>

        <div class="mobile-bottom-nav mobile-only">
            <button class="nav-btn active" onclick="showMobileSection('dashboard')" data-section="dashboard">
                <span class="nav-icon">üè†</span><span class="nav-label">Home</span>
            </button>
            <button class="nav-btn" onclick="showMobileSection('insights')" data-section="insights">
                <span class="nav-icon">üìä</span><span class="nav-label">Insights</span>
            </button>
            <button class="nav-btn" onclick="showMobileSection('categories')" data-section="categories">
                <span class="nav-icon">üìù</span><span class="nav-label">Details</span>
            </button>
            <button class="nav-btn" onclick="showMobileSection('menu')" data-section="menu">
                <span class="nav-icon">‚ò∞</span><span class="nav-label">Menu</span>
            </button>
        </div>

        <div class="container">
            <div class="header">
                <h1 id="monthName">October</h1>
                <div class="subtitle">‚Ä¢ULTIMATE BUDGET DASHBOARD‚Ä¢</div>
            </div>
            
            <div class="top-controls">
                <div class="control-group">
                    <label>BUDGET PERIOD</label>
                    <div class="date-inputs">
                        <input type="date" id="startDate" value="2025-10-01" onchange="updateMonth()">
                        <span>-</span>
                        <input type="date" id="endDate" value="2025-10-31" onchange="updateMonth()">
                    </div>
                </div>
                <div class="control-group">
                    <label>CURRENCY</label>
                    <select id="currency" onchange="updateAll()">
                        <option value="‚Çπ">‚Çπ (INR)</option>
                        <option value="$">$ (USD)</option>
                        <option value="‚Ç¨">‚Ç¨ (EUR)</option>
                        <option value="¬£">¬£ (GBP)</option>
                        <option value="¬•">¬• (JPY)</option>
                    </select>
                </div>
            </div>

            <div class="desktop-content">
                <div id="goalsSection" class="goals-section" style="display: none;">
                    <h3>üéØ Your Budget Goals</h3>
                    <div id="goalsContainer"></div>
                </div>

                <div class="dashboard-card white rule-visualizer">
                    <h3>üéØ 50/30/20 BUDGET RULE</h3>
                    <div id="rule503020Container"></div>
                </div>

                <div class="dashboard-card white savings-rate-card">
                    <h3>üìà SAVINGS RATE TRACKER</h3>
                    <div id="savingsRateContainer"></div>
                </div>
                
                <div class="summary-cards">
                    <div class="summary-card">
                        <div class="label">üí∞ INCOME</div>
                        <div class="amount" id="summaryIncome">‚Çπ10,600.00</div>
                    </div>
                    <div class="summary-card">
                        <div class="label">üõçÔ∏è EXPENSES</div>
                        <div class="amount" id="summaryExpenses">‚Çπ0.00</div>
                    </div>
                    <div class="summary-card">
                        <div class="label">üìÑ BILLS</div>
                        <div class="amount" id="summaryBills">‚Çπ2,828.50</div>
                    </div>
                    <div class="summary-card">
                        <div class="label">üíµ SAVINGS</div>
                        <div class="amount" id="summarySavings">‚Çπ4,570.00</div>
                    </div>
                    <div class="summary-card">
                        <div class="label">üí≥ DEBT</div>
                        <div class="amount" id="summaryDebt">‚Çπ855.00</div>
                    </div>
                </div>

                <div class="dashboard-row">
                    <div class="dashboard-card">
                        <h3>FINANCIAL OVERVIEW</h3>
                        <div class="financial-table">
                            <table>
                                <thead>
                                    <tr><th></th><th>PLANNED</th><th>ACTUAL</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>‚Ä¢ Income</td><td id="foIncomePlanned">‚Çπ10,600.00</td><td id="foIncomeActual">‚Çπ10,600.00</td></tr>
                                    <tr><td>- Expenses</td><td id="foExpensesPlanned">‚Çπ0.00</td><td id="foExpensesActual">‚Çπ0.00</td></tr>
                                    <tr><td>- Bills</td><td id="foBillsPlanned">‚Çπ2,828.50</td><td id="foBillsActual">‚Çπ2,828.50</td></tr>
                                    <tr><td>- Savings</td><td id="foSavingsPlanned">‚Çπ4,570.00</td><td id="foSavingsActual">‚Çπ4,570.00</td></tr>
                                    <tr><td>- Debt</td><td id="foDebtPlanned">‚Çπ855.00</td><td id="foDebtActual">‚Çπ855.00</td></tr>
                                    <tr class="total-row"><td>LEFT</td><td id="foLeftPlanned">‚Çπ0.00</td><td id="foLeftActual">‚Çπ0.00</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="dashboard-card white">
                        <h3>AMOUNT LEFT TO SPEND</h3>
                        <div class="amount-left">
                            <div class="big-amount" id="amountLeft">‚Çπ0.00</div>
                        </div>
                    </div>
                    <div class="dashboard-card white">
                        <h3>CASH FLOW</h3>
                        <div class="cash-flow-chart" id="cashFlow"></div>
                    </div>
                </div>

                <div class="dashboard-card white">
                    <h3>üìä BUDGET VS ACTUAL COMPARISON</h3>
                    <canvas id="budgetComparisonChart"></canvas>
                </div>

                <div class="dashboard-row">
                    <div class="dashboard-card white">
                        <h3>üìà SPENDING TRENDS (Last 6 Months)</h3>
                        <canvas id="trendsChart"></canvas>
                    </div>
                    <div class="dashboard-card white">
                        <h3>BUDGET BREAKDOWN</h3>
                        <div id="pieChart"></div>
                    </div>
                </div>
            </div>

            <div class="desktop-category-tables">
                <div class="category-tables">
                    <div class="category-card">
                        <h3>üí∞ INCOME</h3>
                        <table class="category-table">
                            <thead><tr><th></th><th>PLANNED</th><th>ACTUAL</th></tr></thead>
                            <tbody id="incomeTable"></tbody>
                        </table>
                    </div>
                    <div class="category-card">
                        <h3>üìÑ BILLS</h3>
                        <table class="category-table">
                            <thead><tr><th></th><th>PLANNED</th><th>ACTUAL</th><th>‚úì</th></tr></thead>
                            <tbody id="billsTable"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="category-tables">
                    <div class="category-card">
                        <h3>üõçÔ∏è EXPENSES</h3>
                        <table class="category-table">
                            <thead><tr><th></th><th>PLANNED</th><th>ACTUAL</th><th>‚úì</th></tr></thead>
                            <tbody id="expensesTable"></tbody>
                        </table>
                    </div>
                    <div class="category-card">
                        <h3>üíµ SAVINGS</h3>
                        <table class="category-table">
                            <thead><tr><th></th><th>PLANNED</th><th>ACTUAL</th><th>‚úì</th></tr></thead>
                            <tbody id="savingsTable"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="category-tables">
                    <div class="category-card">
                        <h3>üí≥ DEBT</h3>
                        <table class="category-table">
                            <thead><tr><th></th><th>PLANNED</th><th>ACTUAL</th><th>‚úì</th></tr></thead>
                            <tbody id="debtTable"></tbody>
                        </table>
                    </div>
                    <div></div>
                </div>
            </div>

            <div class="mobile-only">
                <div class="mobile-section active" id="section-dashboard">
                    <div class="summary-cards">
                        <div class="summary-card"><div class="label">üí∞ INCOME</div><div class="amount" id="summaryIncomeMobile">‚Çπ10,600.00</div></div>
                        <div class="summary-card"><div class="label">üõçÔ∏è EXPENSES</div><div class="amount" id="summaryExpensesMobile">‚Çπ0.00</div></div>
                        <div class="summary-card"><div class="label">üìÑ BILLS</div><div class="amount" id="summaryBillsMobile">‚Çπ2,828.50</div></div>
                        <div class="summary-card"><div class="label">üíµ SAVINGS</div><div class="amount" id="summarySavingsMobile">‚Çπ4,570.00</div></div>
                        <div class="summary-card"><div class="label">üí≥ DEBT</div><div class="amount" id="summaryDebtMobile">‚Çπ855.00</div></div>
                    </div>
                    <div class="dashboard-card white">
                        <h3>AMOUNT LEFT TO SPEND</h3>
                        <div class="amount-left"><div class="big-amount" id="amountLeftMobile">‚Çπ0.00</div></div>
                    </div>
                </div>

                <div class="mobile-section" id="section-insights" style="display: none;">
                    <div class="dashboard-card white">
                        <h3>üìä BUDGET BREAKDOWN</h3>
                        <div id="pieChartMobile"></div>
                    </div>
                </div>

                <div class="mobile-section" id="section-categories" style="display: none;">
                    <h3 style="text-align: center; margin-bottom: 20px;">üìù Category Details</h3>
                    <p style="text-align: center; padding: 10px; color: #666; font-size: 14px;">
                        On desktop, scroll down to see all category tables with add/edit features.
                    </p>
                </div>

                <div class="mobile-section mobile-menu-section" id="section-menu" style="display: none;">
                    <div class="mobile-menu-header">
                        <div id="userAvatarMobile" class="user-avatar"></div>
                        <div style="flex: 1; margin-left: 15px;">
                            <p style="margin: 0; font-size: 12px; color: #666;">Logged in as:</p>
                            <p style="margin: 0; font-weight: 600; font-size: 14px;" id="userEmailDisplayMobile"></p>
                        </div>
                    </div>
                    <div class="mobile-menu-items">
                        <button onclick="toggleDarkMode()" class="mobile-menu-btn">
                            <span id="darkModeIconMobile">üåô</span><span id="darkModeTextMobile">Dark Mode</span>
                        </button>
                        <button onclick="exportToPDF()" class="mobile-menu-btn"><span>üì•</span><span>Export PDF</span></button>
                        <button onclick="exportToCSV()" class="mobile-menu-btn"><span>üìä</span><span>Export CSV</span></button>
                        <button onclick="showBackupRestore()" class="mobile-menu-btn"><span>üíæ</span><span>Backup & Restore</span></button>
                        <button onclick="showGoalsModal()" class="mobile-menu-btn"><span>üéØ</span><span>Budget Goals</span></button>
                        <button onclick="showRecurringTransactions()" class="mobile-menu-btn"><span>üîÑ</span><span>Recurring Items</span></button>
                        <button onclick="showMonthComparison()" class="mobile-menu-btn"><span>üìä</span><span>Compare Months</span></button>
                        <button onclick="viewPreviousMonths()" class="mobile-menu-btn"><span>üìÖ</span><span>Previous Months</span></button>
                        <button onclick="viewYearlySummary()" class="mobile-menu-btn"><span>üìà</span><span>Yearly Summary</span></button>
                        <button onclick="clearAllData()" class="mobile-menu-btn danger-btn"><span>üóëÔ∏è</span><span>Clear All Data</span></button>
                        <button onclick="handleLogout()" class="mobile-menu-btn logout-btn"><span>üö™</span><span>Logout</span></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="restoreFileInput" accept=".json" style="display: none;" onchange="handleRestoreFile(event)">
    
    <script>
// ===== BUDGET DASHBOARD PRO - COMPLETE WITH ALL FEATURES =====

let currentUser = null;
let currency = '‚Çπ';
let currentMonth = '';
let currentYear = '';
let data = getDefaultData();
let filterState = { expenses: 'all', bills: 'all', savings: 'all', debt: 'all' };
let trendsChart = null;

// ===== DEFAULT DATA =====
function getDefaultData() {
  return {
    income: [
      { name: 'Salary', planned: 10000, actual: 10000, checked: true, category: 'income', tags: [] },
      { name: 'Freelance', planned: 600, actual: 600, checked: true, category: 'income', tags: [] }
    ],
    expenses: [
      { name: 'Groceries', planned: 0, actual: 0, checked: false, category: 'needs', tags: [] },
      { name: 'Entertainment', planned: 0, actual: 0, checked: false, category: 'wants', tags: [] }
    ],
    bills: [
      { name: 'Rent', planned: 1500, actual: 1500, checked: true, category: 'needs', tags: [] },
      { name: 'Electricity', planned: 100, actual: 100, checked: true, category: 'needs', tags: [] },
      { name: 'Internet', planned: 50, actual: 50, checked: true, category: 'needs', tags: [] },
      { name: 'Phone', planned: 45.50, actual: 45.50, checked: true, category: 'needs', tags: [] },
      { name: 'Water', planned: 40, actual: 40, checked: true, category: 'needs', tags: [] },
      { name: 'Netflix', planned: 15, actual: 15, checked: true, category: 'wants', tags: [] },
      { name: 'Gym', planned: 78, actual: 78, checked: true, category: 'wants', tags: [] }
    ],
    savings: [
      { name: 'Retirement Fund', planned: 2000, actual: 2000, checked: true, category: 'savings', tags: [] },
      { name: 'Emergency Fund', planned: 1500, actual: 1500, checked: true, category: 'savings', tags: [] },
      { name: 'Vacation', planned: 1070, actual: 1070, checked: true, category: 'savings', tags: [] }
    ],
    debt: [
      { name: 'Car Loan', planned: 355, actual: 355, checked: true, category: 'debt', tags: [] },
      { name: 'Credit Card', planned: 500, actual: 500, checked: true, category: 'debt', tags: [] }
    ]
  };
}

// ===== STORAGE =====
function getUserStorageKey(key) {
  if (!currentUser) return key;
  return `budget_${currentUser.email}_${key}`;
}

function saveData() {
  if (!currentUser) return;
  const monthKey = `${currentYear}_${String(currentMonth).padStart(2, '0')}`;
  const storageKey = getUserStorageKey(monthKey);
  localStorage.setItem(storageKey, JSON.stringify(data));
  
  let savedMonths = getSavedMonths();
  if (!savedMonths.includes(monthKey)) {
    savedMonths.push(monthKey);
    localStorage.setItem(getUserStorageKey('savedMonthsList'), JSON.stringify(savedMonths));
  }
}

function loadMonthData() {
  if (!currentUser) return;
  const monthKey = `${currentYear}_${String(currentMonth).padStart(2, '0')}`;
  const storageKey = getUserStorageKey(monthKey);
  const saved = localStorage.getItem(storageKey);
  data = saved ? JSON.parse(saved) : getDefaultData();
}

function getSavedMonths() {
  if (!currentUser) return [];
  const saved = localStorage.getItem(getUserStorageKey('savedMonthsList'));
  return saved ? JSON.parse(saved) : [];
}

// ===== AUTH =====
function getUsers() {
  const users = localStorage.getItem('budget_users');
  return users ? JSON.parse(users) : {};
}

function saveUsers(users) {
  localStorage.setItem('budget_users', JSON.stringify(users));
}

function checkAuth() {
  const loggedInUser = localStorage.getItem('currentUser');
  if (loggedInUser) {
    currentUser = JSON.parse(loggedInUser);
    showDashboard();
  } else {
    showAuthScreen();
  }
}

function handleLogout() {
  if (confirm('Are you sure you want to logout?')) {
    localStorage.removeItem('currentUser');
    currentUser = null;
    location.reload();
  }
}

function showAuthScreen() {
  document.getElementById('loadingScreen').style.display = 'none';
  document.getElementById('authScreen').style.display = 'flex';
  document.getElementById('mainDashboard').style.display = 'none';
}

function showDashboard() {
  document.getElementById('loadingScreen').style.display = 'none';
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('mainDashboard').style.display = 'block';
  document.getElementById('userEmailDisplay').textContent = currentUser.email;
  
  createUserAvatar(currentUser.email);
  updateMobileAvatar();
  loadDarkMode();
  
  const today = new Date();
  currentYear = today.getFullYear();
  currentMonth = today.getMonth();
  
  loadMonthData();
  initializeCategories();
  updateMonth();
  updateAll();
  updateTrendsChart();
  update503020Display();
  updateSavingsRateDisplay();
  updateBudgetComparisonChart();
  updateGoalsDisplay();
  
  showMobileSection('dashboard');
}

function hideMessages() {
  document.getElementById('errorMessage').style.display = 'none';
  document.getElementById('successMessage').style.display = 'none';
}

function showError(message) {
  const errorDiv = document.getElementById('errorMessage');
  errorDiv.textContent = message;
  errorDiv.style.display = 'block';
}

function showSuccess(message) {
  const successDiv = document.getElementById('successMessage');
  successDiv.textContent = message;
  successDiv.style.display = 'block';
}

// ===== CATEGORIES =====
function getCategoryForItem(itemName, categoryType) {
  const needsKeywords = ['rent', 'apartment', 'mortgage', 'electricity', 'water', 'groceries', 'internet', 'insurance', 'fuel'];
  const wantsKeywords = ['entertainment', 'movies', 'netflix', 'gym', 'vacation'];
  const savingsKeywords = ['retirement', 'emergency', 'savings', 'investment'];
  const debtKeywords = ['loan', 'credit', 'debt', 'lease'];
  
  const lowerName = itemName.toLowerCase();
  
  if (categoryType === 'savings' || savingsKeywords.some(k => lowerName.includes(k))) return 'savings';
  if (categoryType === 'debt' || debtKeywords.some(k => lowerName.includes(k))) return 'debt';
  if (wantsKeywords.some(k => lowerName.includes(k))) return 'wants';
  if (needsKeywords.some(k => lowerName.includes(k))) return 'needs';
  
  return categoryType === 'bills' ? 'needs' : 'wants';
}

function initializeCategories() {
  ['expenses', 'bills', 'savings', 'debt'].forEach(category => {
    data[category].forEach(item => {
      if (!item.category) item.category = getCategoryForItem(item.name, category);
      if (!item.tags) item.tags = [];
    });
  });
}

// ===== RECURRING TRANSACTIONS =====
function getRecurringTransactions() {
  if (!currentUser) return [];
  const key = getUserStorageKey('recurring');
  const saved = localStorage.getItem(key);
  return saved ? JSON.parse(saved) : [];
}

function saveRecurringTransactions(recurring) {
  if (!currentUser) return;
  localStorage.setItem(getUserStorageKey('recurring'), JSON.stringify(recurring));
}

function showRecurringTransactions() {
  const recurring = getRecurringTransactions();
  let html = `
    <div style="margin-bottom: 20px;">
      <h3 style="margin-bottom: 15px;">Recurring Transactions üîÑ</h3>
      <button onclick="addRecurringTransaction()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
        + Add Recurring Transaction
      </button>
    </div>
  `;
  
  if (recurring.length === 0) {
    html += '<p style="color: #666; text-align: center; padding: 40px;">No recurring transactions. Add bills or expenses that repeat monthly!</p>';
  } else {
    recurring.forEach((item, index) => {
      const frequencyText = item.frequency === 'monthly' ? 'Every month' : item.frequency === 'weekly' ? 'Every week' : 'Every year';
      html += `
        <div style="background: #f8f5ff; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #8b5cf6;">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <h4 style="margin: 0 0 5px 0;">${item.name}</h4>
              <p style="margin: 0; color: #666; font-size: 13px;">
                ${formatCurrency(item.amount)} ‚Ä¢ ${frequencyText} ‚Ä¢ ${item.category}
              </p>
              <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">Next: ${item.nextDate}</p>
            </div>
            <div>
              <button onclick="applyRecurring(${index})" style="background: #10b981; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 12px;">Apply Now</button>
              <button onclick="deleteRecurring(${index})" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">Delete</button>
            </div>
          </div>
        </div>
      `;
    });
  }
  showModal('Recurring Transactions', html);
}

function addRecurringTransaction() {
  const name = prompt('Transaction name (e.g., "Rent"):');
  if (!name) return;
  const amount = parseFloat(prompt('Amount:'));
  if (isNaN(amount) || amount <= 0) { showToast('Invalid amount', 'error'); return; }
  const category = prompt('Category (expenses/bills/savings/debt):') || 'expenses';
  const frequency = prompt('Frequency (monthly/weekly/yearly):') || 'monthly';
  const recurring = getRecurringTransactions();
  recurring.push({ name: name.trim(), amount, category, frequency, nextDate: new Date().toISOString().split('T')[0], autoApply: false });
  saveRecurringTransactions(recurring);
  showToast('Recurring transaction added! üîÑ', 'success');
  showRecurringTransactions();
}

function applyRecurring(index) {
  const recurring = getRecurringTransactions();
  const item = recurring[index];
  if (!data[item.category]) { showToast('Invalid category', 'error'); return; }
  const existingIndex = data[item.category].findIndex(i => i.name === item.name);
  if (existingIndex >= 0) {
    data[item.category][existingIndex].actual += item.amount;
  } else {
    data[item.category].push({ name: item.name, planned: item.amount, actual: item.amount, checked: true, category: getCategoryForItem(item.name, item.category), tags: [] });
  }
  const nextDate = new Date(item.nextDate);
  if (item.frequency === 'monthly') nextDate.setMonth(nextDate.getMonth() + 1);
  else if (item.frequency === 'weekly') nextDate.setDate(nextDate.getDate() + 7);
  else if (item.frequency === 'yearly') nextDate.setFullYear(nextDate.getFullYear() + 1);
  recurring[index].nextDate = nextDate.toISOString().split('T')[0];
  saveRecurringTransactions(recurring);
  updateAll();
  showToast(`Applied: ${item.name}`, 'success');
  showRecurringTransactions();
}

function deleteRecurring(index) {
  if (!confirm('Delete this recurring transaction?')) return;
  const recurring = getRecurringTransactions();
  recurring.splice(index, 1);
  saveRecurringTransactions(recurring);
  showToast('Recurring transaction deleted', 'info');
  showRecurringTransactions();
}

// ===== GOALS =====
function getUserGoals() {
  if (!currentUser) return [];
  const saved = localStorage.getItem(getUserStorageKey('goals'));
  return saved ? JSON.parse(saved) : [];
}

function saveUserGoals(goals) {
  if (!currentUser) return;
  localStorage.setItem(getUserStorageKey('goals'), JSON.stringify(goals));
}

function showGoalsModal() {
  const goals = getUserGoals();
  let html = `
    <div style="margin-bottom: 20px;">
      <h3 style="margin-bottom: 15px;">Set Your Budget Goals üéØ</h3>
      <button onclick="addNewGoal()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
        + Add New Goal
      </button>
    </div>
  `;
  if (goals.length === 0) {
    html += '<p style="color: #666; text-align: center; padding: 40px;">No goals yet. Create your first goal!</p>';
  } else {
    goals.forEach((goal, index) => {
      const progress = goal.target > 0 ? (goal.current / goal.target * 100) : 0;
      const progressColor = progress >= 100 ? '#10b981' : progress >= 75 ? '#3b82f6' : progress >= 50 ? '#f59e0b' : '#ef4444';
      html += `
        <div style="background: #f8f5ff; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
            <div><h4 style="margin: 0 0 5px 0;">${goal.name}</h4><p style="margin: 0; color: #666; font-size: 14px;">${currency}${goal.current.toLocaleString()} of ${currency}${goal.target.toLocaleString()}</p></div>
            <button onclick="deleteGoal(${index})" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Delete</button>
          </div>
          <div style="background: #e9d5ff; border-radius: 8px; height: 24px; overflow: hidden;">
            <div style="background: ${progressColor}; height: 100%; width: ${Math.min(progress, 100)}%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">${progress.toFixed(1)}%</div>
          </div>
          ${progress >= 100 ? '<p style="margin: 10px 0 0 0; color: #10b981; font-weight: bold;">üéâ Goal Achieved!</p>' : ''}
        </div>
      `;
    });
  }
  showModal('Budget Goals', html);
}

function addNewGoal() {
  const name = prompt('Goal name (e.g., "Save for vacation"):');
  if (!name) return;
  const target = parseFloat(prompt('Target amount:'));
  if (isNaN(target) || target <= 0) { showToast('Invalid target amount', 'error'); return; }
  const goals = getUserGoals();
  goals.push({ name: name.trim(), target, current: 0, createdAt: new Date().toISOString() });
  saveUserGoals(goals);
  showToast('Goal added successfully! üéØ', 'success');
  showGoalsModal();
}

function deleteGoal(index) {
  if (!confirm('Delete this goal?')) return;
  const goals = getUserGoals();
  goals.splice(index, 1);
  saveUserGoals(goals);
  showToast('Goal deleted', 'info');
  showGoalsModal();
}

function updateGoalsDisplay() {
  const goals = getUserGoals();
  const goalsSection = document.getElementById('goalsSection');
  const goalsContainer = document.getElementById('goalsContainer');
  if (!goalsSection || !goalsContainer) return;
  if (goals.length === 0) { goalsSection.style.display = 'none'; return; }
  goalsSection.style.display = 'block';
  const totalSavings = calculateTotal('savings', 'actual');
  goals.forEach(goal => { goal.current = Math.min(totalSavings, goal.target); });
  saveUserGoals(goals);
  let html = '';
  goals.forEach((goal, index) => {
    const progress = goal.target > 0 ? (goal.current / goal.target * 100) : 0;
    const progressColor = progress >= 100 ? '#10b981' : progress >= 75 ? '#3b82f6' : progress >= 50 ? '#f59e0b' : '#ef4444';
    html += `
      <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 2px solid #e9d5ff;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <strong>${goal.name}</strong>
          <span style="font-size: 14px; color: #666;">${currency}${goal.current.toLocaleString()} / ${currency}${goal.target.toLocaleString()}</span>
        </div>
        <div style="background: #e9d5ff; border-radius: 8px; height: 20px; overflow: hidden;">
          <div style="background: ${progressColor}; height: 100%; width: ${Math.min(progress, 100)}%; transition: width 0.3s; display: flex; align-items: center; padding-left: 8px; color: white; font-weight: bold; font-size: 11px;">${progress.toFixed(0)}%</div>
        </div>
      </div>
    `;
  });
  goalsContainer.innerHTML = html;
}

// ===== 50/30/20 RULE =====
function update503020Display() {
  const container = document.getElementById('rule503020Container');
  if (!container) return;
  const totalIncome = calculateTotal('income', 'actual');
  if (totalIncome === 0) {
    container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Add income data to see your 50/30/20 analysis</p>';
    return;
  }
  const needsActual = data.expenses.filter(e => e.category === 'needs').reduce((sum, e) => sum + (e.actual || 0), 0) + data.bills.filter(b => b.category === 'needs').reduce((sum, b) => sum + (b.actual || 0), 0);
  const wantsActual = data.expenses.filter(e => e.category === 'wants').reduce((sum, e) => sum + (e.actual || 0), 0) + data.bills.filter(b => b.category === 'wants').reduce((sum, b) => sum + (b.actual || 0), 0);
  const savingsActual = calculateTotal('savings', 'actual');
  const needsIdeal = totalIncome * 0.50;
  const wantsIdeal = totalIncome * 0.30;
  const savingsIdeal = totalIncome * 0.20;
  const needsPercent = (needsActual / totalIncome * 100).toFixed(1);
  const wantsPercent = (wantsActual / totalIncome * 100).toFixed(1);
  const savingsPercent = (savingsActual / totalIncome * 100).toFixed(1);
  container.innerHTML = `
    <div class="rule-container">
      <div class="rule-item">
        <div class="rule-percentage" style="color: #ef4444;">50%</div>
        <div class="rule-label">Needs</div>
        <div class="rule-amount">${formatCurrency(needsActual)}</div>
        <div class="rule-bar"><div class="rule-bar-fill" style="width: ${Math.min((needsActual / needsIdeal * 100), 100)}%; background: #ef4444;"></div></div>
        <div class="rule-status" style="color: ${needsActual <= needsIdeal ? '#10b981' : '#ef4444'};">${needsPercent}% of income</div>
      </div>
      <div class="rule-item">
        <div class="rule-percentage" style="color: #f59e0b;">30%</div>
        <div class="rule-label">Wants</div>
        <div class="rule-amount">${formatCurrency(wantsActual)}</div>
        <div class="rule-bar"><div class="rule-bar-fill" style="width: ${Math.min((wantsActual / wantsIdeal * 100), 100)}%; background: #f59e0b;"></div></div>
        <div class="rule-status" style="color: ${wantsActual <= wantsIdeal ? '#10b981' : '#ef4444'};">${wantsPercent}% of income</div>
      </div>
      <div class="rule-item">
        <div class="rule-percentage" style="color: #3b82f6;">20%</div>
        <div class="rule-label">Savings</div>
        <div class="rule-amount">${formatCurrency(savingsActual)}</div>
        <div class="rule-bar"><div class="rule-bar-fill" style="width: ${Math.min((savingsActual / savingsIdeal * 100), 100)}%; background: #3b82f6;"></div></div>
        <div class="rule-status" style="color: ${savingsActual >= savingsIdeal ? '#10b981' : '#f59e0b'};">${savingsPercent}% of income</div>
      </div>
    </div>
  `;
}

// ===== SAVINGS RATE =====
function updateSavingsRateDisplay() {
  const container = document.getElementById('savingsRateContainer');
  if (!container) return;
  const totalIncome = calculateTotal('income', 'actual');
  const totalSavings = calculateTotal('savings', 'actual');
  if (totalIncome === 0) {
    container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Add income data to track your savings rate</p>';
    return;
  }
  const savingsRate = (totalSavings / totalIncome * 100).toFixed(1);
  const monthlySavings = totalSavings;
  const annualSavings = monthlySavings * 12;
  let rateColor = '#ef4444';
  if (savingsRate >= 20) rateColor = '#10b981';
  else if (savingsRate >= 10) rateColor = '#f59e0b';
  container.innerHTML = `
    <div class="savings-rate-display">
      <div class="savings-rate-percentage" style="color: ${rateColor};">${savingsRate}%</div>
      <div class="savings-rate-label">Your Savings Rate</div>
    </div>
    <div class="savings-trend">
      <div class="trend-item"><div class="trend-value">${formatCurrency(monthlySavings)}</div><div class="trend-label">Monthly</div></div>
      <div class="trend-item"><div class="trend-value">${formatCurrency(annualSavings)}</div><div class="trend-label">Annual</div></div>
    </div>
  `;
}

// ===== CHARTS =====
function updateTrendsChart() {
  const canvas = document.getElementById('trendsChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const savedMonths = getSavedMonths();
  if (savedMonths.length === 0) { canvas.style.display = 'none'; return; }
  canvas.style.display = 'block';
  const monthsData = savedMonths.sort().slice(-6).map(monthKey => {
    const parts = monthKey.split('_');
    const year = parts[0];
    const month = parts[1];
    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const storageKey = getUserStorageKey(monthKey);
    const monthData = JSON.parse(localStorage.getItem(storageKey));
    if (!monthData) return null;
    return {
      label: `${monthNames[parseInt(month)]} ${year}`,
      income: monthData.income.reduce((sum, item) => sum + (item.actual || 0), 0),
      expenses: monthData.expenses.reduce((sum, item) => sum + (item.actual || 0), 0),
      bills: monthData.bills.reduce((sum, item) => sum + (item.actual || 0), 0),
      savings: monthData.savings.reduce((sum, item) => sum + (item.actual || 0), 0)
    };
  }).filter(d => d !== null);
  if (trendsChart) trendsChart.destroy();
  const isDark = document.body.classList.contains('dark-mode');
  const textColor = isDark ? '#e5e7eb' : '#333';
  const gridColor = isDark ? '#374151' : '#e5e7eb';
  trendsChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: monthsData.map(d => d.label),
      datasets: [
        { label: 'Income', data: monthsData.map(d => d.income), borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.4 },
        { label: 'Expenses', data: monthsData.map(d => d.expenses), borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', tension: 0.4 },
        { label: 'Bills', data: monthsData.map(d => d.bills), borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', tension: 0.4 },
        { label: 'Savings', data: monthsData.map(d => d.savings), borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.4 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: true,
      plugins: { legend: { labels: { color: textColor } } },
      scales: {
        y: { beginAtZero: true, ticks: { color: textColor, callback: function(value) { return currency + value.toLocaleString(); } }, grid: { color: gridColor } },
        x: { ticks: { color: textColor }, grid: { color: gridColor } }
      }
    }
  });
}

function updateBudgetComparisonChart() {
  const canvas = document.getElementById('budgetComparisonChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const categories = ['Income', 'Expenses', 'Bills', 'Savings', 'Debt'];
  const planned = [calculateTotal('income', 'planned'), calculateTotal('expenses', 'planned'), calculateTotal('bills', 'planned'), calculateTotal('savings', 'planned'), calculateTotal('debt', 'planned')];
  const actual = [calculateTotal('income', 'actual'), calculateTotal('expenses', 'actual'), calculateTotal('bills', 'actual'), calculateTotal('savings', 'actual'), calculateTotal('debt', 'actual')];
  const isDark = document.body.classList.contains('dark-mode');
  if (window.budgetComparisonChart) window.budgetComparisonChart.destroy();
  window.budgetComparisonChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: categories,
      datasets: [
        { label: 'Planned', data: planned, backgroundColor: 'rgba(139, 92, 246, 0.6)', borderColor: '#8b5cf6', borderWidth: 2 },
        { label: 'Actual', data: actual, backgroundColor: 'rgba(16, 185, 129, 0.6)', borderColor: '#10b981', borderWidth: 2 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: true,
      plugins: { legend: { labels: { color: isDark ? '#e5e7eb' : '#333' } }, tooltip: { callbacks: { label: function(context) { return context.dataset.label + ': ' + formatCurrency(context.raw); } } } },
      scales: {
        y: { beginAtZero: true, ticks: { color: isDark ? '#e5e7eb' : '#333', callback: function(value) { return currency + value.toLocaleString(); } }, grid: { color: isDark ? '#374151' : '#e5e7eb' } },
        x: { ticks: { color: isDark ? '#e5e7eb' : '#333' }, grid: { color: isDark ? '#374151' : '#e5e7eb' } }
      }
    }
  });
}

// ===== BACKUP/RESTORE =====
function showBackupRestore() {
  let html = `
    <h3 style="margin-bottom: 20px;">üíæ Backup & Restore</h3>
    <div style="display: grid; gap: 20px;">
      <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; border-left: 4px solid #10b981;">
        <h4 style="margin: 0 0 10px 0;">üì• Create Backup</h4>
        <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">Download all your budget data as a JSON file</p>
        <button onclick="backupAllData(); closeModal();" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%;">Download Backup</button>
      </div>
      <div style="background: #eff6ff; padding: 20px; border-radius: 8px; border-left: 4px solid #3b82f6;">
        <h4 style="margin: 0 0 10px 0;">üì§ Restore from Backup</h4>
        <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">Upload a previously saved backup file</p>
        <button onclick="document.getElementById('restoreFileInput').click(); closeModal();" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%;">Choose Backup File</button>
      </div>
    </div>
  `;
  showModal('Backup & Restore', html);
}

function backupAllData() {
  if (!currentUser) return;
  const backup = { version: '1.0', timestamp: new Date().toISOString(), user: currentUser.email, currency: currency, currentData: data, goals: getUserGoals(), recurring: getRecurringTransactions(), months: {} };
  const savedMonths = getSavedMonths();
  savedMonths.forEach(monthKey => {
    const storageKey = getUserStorageKey(monthKey);
    const monthData = localStorage.getItem(storageKey);
    if (monthData) backup.months[monthKey] = JSON.parse(monthData);
  });
  const dataStr = JSON.stringify(backup, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `BudgetBackup_${currentUser.email}_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  window.URL.revokeObjectURL(url);
  showToast('‚úÖ Backup created successfully!', 'success');
}

function handleRestoreFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const backup = JSON.parse(e.target.result);
      if (!backup.version || !backup.user || !backup.currentData) { showToast('Invalid backup file format', 'error'); return; }
      if (backup.currentData) { data = backup.currentData; saveData(); }
      if (backup.goals) saveUserGoals(backup.goals);
      if (backup.recurring) saveRecurringTransactions(backup.recurring);
      if (backup.months) {
        Object.keys(backup.months).forEach(monthKey => {
          const storageKey = getUserStorageKey(monthKey);
          localStorage.setItem(storageKey, JSON.stringify(backup.months[monthKey]));
        });
        const monthsListKey = getUserStorageKey('savedMonthsList');
        let savedMonths = getSavedMonths();
        Object.keys(backup.months).forEach(monthKey => { if (!savedMonths.includes(monthKey)) savedMonths.push(monthKey); });
        localStorage.setItem(monthsListKey, JSON.stringify(savedMonths));
      }
      updateAll(); updateTrendsChart(); updateGoalsDisplay();
      showToast('‚úÖ Data restored successfully! Refreshing...', 'success');
      setTimeout(() => location.reload(), 1500);
    } catch (error) {
      console.error('Restore error:', error);
      showToast('‚ùå Failed to restore backup. Invalid file.', 'error');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// ===== MONTH COMPARISON =====
function showMonthComparison() {
  const savedMonths = getSavedMonths();
  if (savedMonths.length < 2) { showToast('Need at least 2 months of data to compare', 'info'); return; }
  const lastMonths = savedMonths.sort().slice(-6);
  const comparisonData = lastMonths.map(monthKey => {
    const parts = monthKey.split('_');
    const year = parts[0]; const month = parts[1];
    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const storageKey = getUserStorageKey(monthKey);
    const monthData = JSON.parse(localStorage.getItem(storageKey));
    if (!monthData) return null;
    return {
      label: `${monthNames[parseInt(month)]} ${year}`,
      income: monthData.income.reduce((sum, item) => sum + (item.actual || 0), 0),
      expenses: monthData.expenses.reduce((sum, item) => sum + (item.actual || 0), 0),
      bills: monthData.bills.reduce((sum, item) => sum + (item.actual || 0), 0),
      savings: monthData.savings.reduce((sum, item) => sum + (item.actual || 0), 0)
    };
  }).filter(d => d !== null);
  let html = `<h3 style="margin-bottom: 20px;">Month-to-Month Comparison üìà</h3><div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #f3f4f6;"><th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb;">Month</th><th style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">Income</th><th style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">Expenses</th><th style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">Bills</th><th style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">Savings</th><th style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">Balance</th></tr></thead><tbody>`;
  comparisonData.forEach(month => {
    const balance = month.income - month.expenses - month.bills - month.savings;
    html += `<tr><td style="padding: 10px; border: 1px solid #e5e7eb;">${month.label}</td><td style="padding: 10px; border: 1px solid #e5e7eb; text-align: right; color: #10b981;">${formatCurrency(month.income)}</td><td style="padding: 10px; border: 1px solid #e5e7eb; text-align: right; color: #ef4444;">${formatCurrency(month.expenses)}</td><td style="padding: 10px; border: 1px solid #e5e7eb; text-align: right; color: #f59e0b;">${formatCurrency(month.bills)}</td><td style="padding: 10px; border: 1px solid #e5e7eb; text-align: right; color: #3b82f6;">${formatCurrency(month.savings)}</td><td style="padding: 10px; border: 1px solid #e5e7eb; text-align: right; font-weight: bold; color: ${balance >= 0 ? '#10b981' : '#ef4444'};">${formatCurrency(balance)}</td></tr>`;
  });
  html += '</tbody></table></div>';
  const avgIncome = comparisonData.reduce((sum, m) => sum + m.income, 0) / comparisonData.length;
  const avgExpenses = comparisonData.reduce((sum, m) => sum + m.expenses, 0) / comparisonData.length;
  const avgSavings = comparisonData.reduce((sum, m) => sum + m.savings, 0) / comparisonData.length;
  html += `<div style="margin-top: 20px; padding: 15px; background: #f8f5ff; border-radius: 8px;"><h4>Averages</h4><p>Monthly Income: ${formatCurrency(avgIncome)}</p><p>Monthly Expenses: ${formatCurrency(avgExpenses)}</p><p>Monthly Savings: ${formatCurrency(avgSavings)}</p><p>Savings Rate: ${(avgSavings / avgIncome * 100).toFixed(1)}%</p></div>`;
  showModal('Month Comparison', html);
}

// ===== VIEW MONTHS =====
function viewPreviousMonths() {
  const savedMonths = getSavedMonths();
  if (savedMonths.length === 0) { showToast('No saved months yet!', 'info'); return; }
  let html = '<div style="max-height: 500px; overflow-y: auto;"><h2 style="margin-bottom: 20px;">Saved Monthly Reports</h2>';
  savedMonths.sort().reverse().forEach(monthKey => {
    const parts = monthKey.split('_');
    const year = parts[0]; const month = parts[1];
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const monthName = monthNames[parseInt(month)];
    const storageKey = getUserStorageKey(monthKey);
    const monthData = JSON.parse(localStorage.getItem(storageKey));
    if (!monthData) return;
    const totalIncome = monthData.income.reduce((sum, item) => sum + (item.actual || 0), 0);
    const totalExpenses = monthData.expenses.reduce((sum, item) => sum + (item.actual || 0), 0);
    const totalBills = monthData.bills.reduce((sum, item) => sum + (item.actual || 0), 0);
    const totalSavings = monthData.savings.reduce((sum, item) => sum + (item.actual || 0), 0);
    const totalDebt = monthData.debt.reduce((sum, item) => sum + (item.actual || 0), 0);
    const balance = totalIncome - totalExpenses - totalBills - totalSavings - totalDebt;
    html += `<div style="background: #f8f5ff; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid #8b5cf6;"><h3 style="margin-bottom: 10px;">${monthName} ${year}</h3><div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 13px;"><div><strong>Income:</strong> ${currency}${totalIncome.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div><div><strong>Expenses:</strong> ${currency}${totalExpenses.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div><div><strong>Bills:</strong> ${currency}${totalBills.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div><div><strong>Savings:</strong> ${currency}${totalSavings.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div><div><strong>Debt:</strong> ${currency}${totalDebt.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div><div><strong>Balance:</strong> <span style="color: ${balance >= 0 ? '#10b981' : '#ef4444'}; font-weight: bold;">${currency}${balance.toLocaleString('en-IN', {minimumFractionDigits: 2})}</span></div></div><div style="margin-top: 10px;"><button onclick="loadMonth('${monthKey}')" style="background: #8b5cf6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Load This Month</button><button onclick="deleteMonth('${monthKey}')" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">Delete</button></div></div>`;
  });
  html += '</div>';
  showModal('Previous Months', html);
}

function viewYearlySummary() {
  const savedMonths = getSavedMonths();
  if (savedMonths.length === 0) { showToast('No saved months yet!', 'info'); return; }
  const yearData = {};
  savedMonths.forEach(monthKey => {
    const parts = monthKey.split('_');
    const year = parts[0];
    if (!yearData[year]) yearData[year] = { income: 0, expenses: 0, bills: 0, savings: 0, debt: 0, months: [] };
    const storageKey = getUserStorageKey(monthKey);
    const monthData = JSON.parse(localStorage.getItem(storageKey));
    if (!monthData) return;
    yearData[year].income += monthData.income.reduce((sum, item) => sum + (item.actual || 0), 0);
    yearData[year].expenses += monthData.expenses.reduce((sum, item) => sum + (item.actual || 0), 0);
    yearData[year].bills += monthData.bills.reduce((sum, item) => sum + (item.actual || 0), 0);
    yearData[year].savings += monthData.savings.reduce((sum, item) => sum + (item.actual || 0), 0);
    yearData[year].debt += monthData.debt.reduce((sum, item) => sum + (item.actual || 0), 0);
    yearData[year].months.push(monthKey);
  });
  let html = '<div style="max-height: 500px; overflow-y: auto;"><h2 style="margin-bottom: 20px;">Yearly Summary</h2>';
  Object.keys(yearData).sort().reverse().forEach(year => {
    const yearInfo = yearData[year];
    const balance = yearInfo.income - yearInfo.expenses - yearInfo.bills - yearInfo.savings - yearInfo.debt;
    html += `<div style="background: #f8f5ff; padding: 20px; margin-bottom: 20px; border-radius: 8px; border: 2px solid #8b5cf6;"><h2 style="margin-bottom: 15px; color: #8b5cf6;">${year} Summary (${yearInfo.months.length} months)</h2><div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; font-size: 14px;"><div style="background: white; padding: 12px; border-radius: 6px;"><div style="color: #666; font-size: 12px; margin-bottom: 4px;">Total Income</div><div style="font-size: 20px; font-weight: bold; color: #10b981;">${currency}${yearInfo.income.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div></div><div style="background: white; padding: 12px; border-radius: 6px;"><div style="color: #666; font-size: 12px; margin-bottom: 4px;">Total Expenses</div><div style="font-size: 20px; font-weight: bold; color: #ef4444;">${currency}${yearInfo.expenses.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div></div><div style="background: white; padding: 12px; border-radius: 6px;"><div style="color: #666; font-size: 12px; margin-bottom: 4px;">Total Bills</div><div style="font-size: 20px; font-weight: bold; color: #f97316;">${currency}${yearInfo.bills.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div></div><div style="background: white; padding: 12px; border-radius: 6px;"><div style="color: #666; font-size: 12px; margin-bottom: 4px;">Total Savings</div><div style="font-size: 20px; font-weight: bold; color: #3b82f6;">${currency}${yearInfo.savings.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div></div><div style="background: white; padding: 12px; border-radius: 6px;"><div style="color: #666; font-size: 12px; margin-bottom: 4px;">Total Debt</div><div style="font-size: 20px; font-weight: bold; color: #ec4899;">${currency}${yearInfo.debt.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div></div><div style="background: white; padding: 12px; border-radius: 6px;"><div style="color: #666; font-size: 12px; margin-bottom: 4px;">Net Balance</div><div style="font-size: 20px; font-weight: bold; color: ${balance >= 0 ? '#10b981' : '#ef4444'};">${currency}${balance.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div></div></div></div>`;
  });
  html += '</div>';
  showModal('Yearly Summary', html);
}

function loadMonth(monthKey) {
  const parts = monthKey.split('_');
  const year = parts[0]; const month = parts[1];
  closeModal();
  setTimeout(() => {
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    if (!startDateInput || !endDateInput) { showToast('Error loading month', 'error'); return; }
    const newDate = `${year}-${String(parseInt(month) + 1).padStart(2, '0')}-01`;
    startDateInput.value = newDate;
    const endDateObj = new Date(year, parseInt(month) + 1, 0);
    endDateInput.value = `${year}-${String(parseInt(month) + 1).padStart(2, '0')}-${endDateObj.getDate()}`;
    const storageKey = getUserStorageKey(monthKey);
    const monthData = localStorage.getItem(storageKey);
    if (monthData) {
      const parsedData = JSON.parse(monthData);
      data.income = parsedData.income || [];
      data.bills = parsedData.bills || [];
      data.expenses = parsedData.expenses || [];
      data.savings = parsedData.savings || [];
      data.debt = parsedData.debt || [];
      updateMonth(); updateAll();
      showToast('Month loaded successfully!', 'success');
    } else { showToast('Error: Month data not found', 'error'); }
  }, 100);
}

function deleteMonth(monthKey) {
  if (!confirm('Are you sure you want to delete this month? This cannot be undone!')) return;
  const storageKey = getUserStorageKey(monthKey);
  localStorage.removeItem(storageKey);
  const monthsListKey = getUserStorageKey('savedMonthsList');
  const savedMonths = getSavedMonths();
  const index = savedMonths.indexOf(monthKey);
  if (index > -1) {
    savedMonths.splice(index, 1);
    localStorage.setItem(monthsListKey, JSON.stringify(savedMonths));
  }
  showToast('Month deleted', 'success');
  viewPreviousMonths();
}

function clearAllData() {
  if (!confirm('Are you sure you want to clear ALL your budget data? This cannot be undone!')) return;
  const savedMonths = getSavedMonths();
  savedMonths.forEach(monthKey => { localStorage.removeItem(getUserStorageKey(monthKey)); });
  localStorage.removeItem(getUserStorageKey('savedMonthsList'));
  localStorage.removeItem(getUserStorageKey('currency'));
  localStorage.removeItem(getUserStorageKey('goals'));
  localStorage.removeItem(getUserStorageKey('recurring'));
  showToast('All data cleared! Refreshing...', 'info');
  setTimeout(() => location.reload(), 1500);
}

// ===== EXPORTS =====
function exportToPDF() {
  showToast('Generating PDF...', 'info');
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(20); doc.setFont(undefined, 'bold');
    doc.text('Budget Report', 105, 20, { align: 'center' });
    doc.setFontSize(12); doc.setFont(undefined, 'normal');
    doc.text(`User: ${currentUser.email}`, 20, 35);
    doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 42);
    doc.text(`Period: ${document.getElementById('startDate').value} to ${document.getElementById('endDate').value}`, 20, 49);
    doc.setFontSize(14); doc.setFont(undefined, 'bold');
    doc.text('Financial Summary', 20, 60);
    doc.setFontSize(11); doc.setFont(undefined, 'normal');
    const totalIncome = calculateTotal('income', 'actual');
    const totalExpenses = calculateTotal('expenses', 'actual');
    const totalBills = calculateTotal('bills', 'actual');
    const totalSavings = calculateTotal('savings', 'actual');
    const totalDebt = calculateTotal('debt', 'actual');
    const balance = totalIncome - totalExpenses - totalBills - totalSavings - totalDebt;
    let yPos = 70;
    doc.text(`Income: ${formatCurrency(totalIncome)}`, 20, yPos); yPos += 7;
    doc.text(`Expenses: ${formatCurrency(totalExpenses)}`, 20, yPos); yPos += 7;
    doc.text(`Bills: ${formatCurrency(totalBills)}`, 20, yPos); yPos += 7;
    doc.text(`Savings: ${formatCurrency(totalSavings)}`, 20, yPos); yPos += 7;
    doc.text(`Debt: ${formatCurrency(totalDebt)}`, 20, yPos); yPos += 7;
    doc.setFont(undefined, 'bold');
    doc.text(`Balance: ${formatCurrency(balance)}`, 20, yPos);
    const monthName = document.getElementById('monthName').textContent;
    doc.save(`Budget_Report_${monthName}_${new Date().toISOString().split('T')[0]}.pdf`);
    showToast('‚úÖ PDF exported successfully!', 'success');
  } catch (error) {
    console.error('Error exporting PDF:', error);
    showToast('‚ùå Failed to export PDF', 'error');
  }
}

function exportToCSV() {
  let csv = 'Category,Item,Planned,Actual,Status\n';
  const categories = ['income', 'expenses', 'bills', 'savings', 'debt'];
  categories.forEach(category => {
    data[category].forEach(item => {
      const status = item.checked ? 'Paid' : 'Unpaid';
      csv += `${category},${item.name},${item.planned},${item.actual},${status}\n`;
    });
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Budget_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  window.URL.revokeObjectURL(url);
  showToast('‚úÖ CSV exported successfully!', 'success');
}

// ===== MONTH & CURRENCY =====
function updateMonth() {
  const startDate = document.getElementById('startDate').value;
  const start = new Date(startDate);
  const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
  currentYear = start.getFullYear();
  currentMonth = start.getMonth();
  document.getElementById('monthName').textContent = `${monthNames[currentMonth]} ${currentYear}`;
  loadMonthData();
  updateAll();
  updateTrendsChart();
}

function formatCurrency(amount) {
  return `${currency}${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
}

function calculateTotal(category, type) {
  return data[category].reduce((sum, item) => sum + (item[type] || 0), 0);
}

// ===== UPDATE ALL =====
function updateAll() {
  currency = document.getElementById('currency').value;
  updateSummaryCards();
  updateFinancialOverview();
  updateAmountLeft();
  updateCashFlow();
  updateCategoryTables();
  update503020Display();
  updateSavingsRateDisplay();
  updateBudgetComparisonChart();
  updatePieChart();
  saveData();
}

function updateSummaryCards() {
  const income = calculateTotal('income', 'actual');
  const expenses = calculateTotal('expenses', 'actual');
  const bills = calculateTotal('bills', 'actual');
  const savings = calculateTotal('savings', 'actual');
  const debt = calculateTotal('debt', 'actual');
  document.getElementById('summaryIncome').textContent = formatCurrency(income);
  document.getElementById('summaryExpenses').textContent = formatCurrency(expenses);
  document.getElementById('summaryBills').textContent = formatCurrency(bills);
  document.getElementById('summarySavings').textContent = formatCurrency(savings);
  document.getElementById('summaryDebt').textContent = formatCurrency(debt);
  if (document.getElementById('summaryIncomeMobile')) {
    document.getElementById('summaryIncomeMobile').textContent = formatCurrency(income);
    document.getElementById('summaryExpensesMobile').textContent = formatCurrency(expenses);
    document.getElementById('summaryBillsMobile').textContent = formatCurrency(bills);
    document.getElementById('summarySavingsMobile').textContent = formatCurrency(savings);
    document.getElementById('summaryDebtMobile').textContent = formatCurrency(debt);
  }
}

function updateFinancialOverview() {
  const categories = ['income', 'expenses', 'bills', 'savings', 'debt'];
  categories.forEach(cat => {
    const planned = calculateTotal(cat, 'planned');
    const actual = calculateTotal(cat, 'actual');
    const plannedId = `fo${cat.charAt(0).toUpperCase() + cat.slice(1)}Planned`;
    const actualId = `fo${cat.charAt(0).toUpperCase() + cat.slice(1)}Actual`;
    if (document.getElementById(plannedId)) {
      document.getElementById(plannedId).textContent = formatCurrency(planned);
      document.getElementById(actualId).textContent = formatCurrency(actual);
    }
  });
  const incomePlanned = calculateTotal('income', 'planned');
  const incomeActual = calculateTotal('income', 'actual');
  const expensesPlanned = calculateTotal('expenses', 'planned') + calculateTotal('bills', 'planned') + calculateTotal('savings', 'planned') + calculateTotal('debt', 'planned');
  const expensesActual = calculateTotal('expenses', 'actual') + calculateTotal('bills', 'actual') + calculateTotal('savings', 'actual') + calculateTotal('debt', 'actual');
  const leftPlanned = incomePlanned - expensesPlanned;
  const leftActual = incomeActual - expensesActual;
  document.getElementById('foLeftPlanned').textContent = formatCurrency(leftPlanned);
  document.getElementById('foLeftActual').textContent = formatCurrency(leftActual);
}

function updateAmountLeft() {
  const income = calculateTotal('income', 'actual');
  const totalSpent = calculateTotal('expenses', 'actual') + calculateTotal('bills', 'actual') + calculateTotal('savings', 'actual') + calculateTotal('debt', 'actual');
  const left = income - totalSpent;
  document.getElementById('amountLeft').textContent = formatCurrency(left);
  if (document.getElementById('amountLeftMobile')) {
    document.getElementById('amountLeftMobile').textContent = formatCurrency(left);
  }
}

function updateCashFlow() {
  const cashFlowDiv = document.getElementById('cashFlow');
  if (!cashFlowDiv) return;
  const categories = [
    { name: 'Income', planned: calculateTotal('income', 'planned'), actual: calculateTotal('income', 'actual') },
    { name: 'Expenses', planned: calculateTotal('expenses', 'planned'), actual: calculateTotal('expenses', 'actual') },
    { name: 'Bills', planned: calculateTotal('bills', 'planned'), actual: calculateTotal('bills', 'actual') },
    { name: 'Savings', planned: calculateTotal('savings', 'planned'), actual: calculateTotal('savings', 'actual') },
    { name: 'Debt', planned: calculateTotal('debt', 'planned'), actual: calculateTotal('debt', 'actual') }
  ];
  const maxAmount = Math.max(...categories.map(c => Math.max(c.planned, c.actual)));
  let html = '';
  categories.forEach(cat => {
    const plannedWidth = maxAmount > 0 ? (cat.planned / maxAmount * 100) : 0;
    const actualWidth = maxAmount > 0 ? (cat.actual / maxAmount * 100) : 0;
    html += `<div class="chart-item"><div class="chart-label"><span>${cat.name}</span><span>P: ${formatCurrency(cat.planned)} | A: ${formatCurrency(cat.actual)}</span></div><div class="chart-bars"><div class="chart-bar planned" style="width: ${plannedWidth}%;"></div><div class="chart-bar actual" style="width: ${actualWidth}%;"></div></div></div>`;
  });
  cashFlowDiv.innerHTML = html;
}

function updatePieChart() {
  const totalIncome = calculateTotal('income', 'actual');
  const totalExpenses = calculateTotal('expenses', 'actual');
  const totalBills = calculateTotal('bills', 'actual');
  const totalSavings = calculateTotal('savings', 'actual');
  const totalDebt = calculateTotal('debt', 'actual');
  const leftAmount = totalIncome - totalExpenses - totalBills - totalSavings - totalDebt;
  const pieChartContainer = document.getElementById('pieChart');
  const pieChartMobileContainer = document.getElementById('pieChartMobile');
  const categories = [
    { name: 'Expenses', value: totalExpenses, color: '#f87171' },
    { name: 'Bills', value: totalBills, color: '#fb923c' },
    { name: 'Savings', value: totalSavings, color: '#34d399' },
    { name: 'Debt', value: totalDebt, color: '#f472b6' },
    { name: 'Balance', value: Math.max(0, leftAmount), color: '#60a5fa' }
  ];
  const total = categories.reduce((sum, cat) => sum + cat.value, 0);
  const generatePieChartHTML = () => {
    if (total === 0) return '<div style="text-align: center; padding: 40px; color: #999;">No data to display</div>';
    let currentAngle = 0;
    const centerX = 100; const centerY = 100; const radius = 80;
    let svgPaths = ''; let legends = '';
    categories.forEach((cat) => {
      const percentage = (cat.value / total) * 100;
      if (percentage > 0) {
        const sliceAngle = (cat.value / total) * 360;
        const endAngle = currentAngle + sliceAngle;
        const startX = centerX + radius * Math.cos((currentAngle - 90) * Math.PI / 180);
        const startY = centerY + radius * Math.sin((currentAngle - 90) * Math.PI / 180);
        const endX = centerX + radius * Math.cos((endAngle - 90) * Math.PI / 180);
        const endY = centerY + radius * Math.sin((endAngle - 90) * Math.PI / 180);
        const largeArc = sliceAngle > 180 ? 1 : 0;
        svgPaths += `<path d="M ${centerX} ${centerY} L ${startX} ${startY} A ${radius} ${radius} 0 ${largeArc} 1 ${endX} ${endY} Z" fill="${cat.color}" stroke="white" stroke-width="2" style="transition: all 0.3s;"><title>${cat.name}: ${formatCurrency(cat.value)} (${percentage.toFixed(1)}%)</title></path>`;
        legends += `<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;"><div style="width: 16px; height: 16px; background: ${cat.color}; border-radius: 3px;"></div><div style="flex: 1; font-size: 12px;"><div style="font-weight: 600;">${cat.name}</div><div style="color: #666;">${formatCurrency(cat.value)} (${percentage.toFixed(1)}%)</div></div></div>`;
        currentAngle = endAngle;
      }
    });
    return `<div style="display: flex; gap: 30px; align-items: center; justify-content: center;"><svg width="200" height="200" viewBox="0 0 200 200">${svgPaths}</svg><div style="flex: 1;">${legends}</div></div>`;
  };
  const chartHTML = generatePieChartHTML();
  if (pieChartContainer) pieChartContainer.innerHTML = chartHTML;
  if (pieChartMobileContainer) pieChartMobileContainer.innerHTML = chartHTML;
}

// ===== CATEGORY TABLES =====
function updateCategoryTables() {
  updateCategoryTable('income', 'incomeTable', false);
  updateCategoryTable('expenses', 'expensesTable', true);
  updateCategoryTable('bills', 'billsTable', true);
  updateCategoryTable('savings', 'savingsTable', true);
  updateCategoryTable('debt', 'debtTable', true);
}

function updateCategoryTable(category, tableId, hasCheckbox) {
  const tbody = document.getElementById(tableId);
  if (!tbody) return;
  let html = '';
  let totalPlanned = 0;
  let totalActual = 0;
  data[category].forEach((item, index) => {
    totalPlanned += item.planned || 0;
    totalActual += item.actual || 0;
    html += `<tr>`;
    html += `<td><div class="item-row"><span>${item.name}</span></div></td>`;
    html += `<td><input type="number" value="${item.planned}" onchange="updateItem('${category}', ${index}, 'planned', this.value)" step="0.01"></td>`;
    html += `<td><input type="number" value="${item.actual}" onchange="updateItem('${category}', ${index}, 'actual', this.value)" step="0.01"></td>`;
    if (hasCheckbox) {
      html += `<td><input type="checkbox" ${item.checked ? 'checked' : ''} onchange="updateItem('${category}', ${index}, 'checked', this.checked)"></td>`;
    }
    html += `</tr>`;
  });
  html += `<tr class="total-row">`;
  html += `<td><strong>TOTAL</strong></td>`;
  html += `<td><strong>${formatCurrency(totalPlanned)}</strong></td>`;
  html += `<td><strong>${formatCurrency(totalActual)}</strong></td>`;
  if (hasCheckbox) html += `<td></td>`;
  html += `</tr>`;
  tbody.innerHTML = html;
}

function updateItem(category, index, field, value) {
  if (field === 'checked') {
    data[category][index][field] = value;
  } else {
    data[category][index][field] = parseFloat(value) || 0;
  }
  updateAll();
}

// ===== TOAST =====
function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  if (!container) return;
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => toast.classList.add('show
